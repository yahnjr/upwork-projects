<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POI Finder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      max-width: 300px;
      z-index: 1;
    }
    .input-group {
      margin-bottom: 10px;
    }
    input[type="text"], select, input[type="number"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 4px;
    }
    button {
      padding: 8px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
    }
    button:hover {
      background-color: #3367d6;
    }
    .poi-list {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    .poi-item {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .poi-item:hover {
      background-color: #f5f5f5;
    }
    .loading {
      display: none;
      margin-top: 10px;
    }
    .mapboxgl-popup {
      max-width: 300px;
    }
    .mapboxgl-popup-content {
      padding: 15px;
    }
    .property-search-form {
      margin-top: 10px;
    }
    .property-popup-content h4, .poi-popup-content h4 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .poi-details {
      font-size: 13px;
    }
    .poi-details table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .poi-details td {
      padding: 4px 0;
      vertical-align: top;
    }
    .poi-details td:first-child {
      font-weight: bold;
      width: 35%;
    }
    .poi-popup-content a {
      color: #4285f4;
      text-decoration: none;
    }
    .poi-popup-content a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-panel">
    <h2>POI Finder</h2>
    <p>You can also click the map to locate POI's within a quarter mile of that location.</p>
    <div class="input-group">
      <label for="address">Search Address:</label>
      <input type="text" id="address" placeholder="Enter an address">
    </div>
    <button id="search-btn">Search</button>
    <div class="loading" id="loading">Searching...</div>
    <div class="poi-list" id="poi-list"></div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY29sdW1iaWFzbG91Z2giLCJhIjoiY201MWFrbTBmMHN1aTJwcHd1dHloMGs4YyJ9.kQj7ux3XSeQiOBwxzM5B9g';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-74.5, 40], 
      zoom: 9
    });

    map.addControl(new mapboxgl.NavigationControl());

    let currentMarker = null;
    let poiMarkers = [];
    let selectedPropertyId = null;

    const addressInput = document.getElementById('address');
    const searchBtn = document.getElementById('search-btn');
    const poiList = document.getElementById('poi-list');
    const loading = document.getElementById('loading');

    function loadProperties() {
        return fetch('properties.geojson')
            .then(response => response.json())
            .then(data => {
                map.addSource('properties', {
                    type: 'geojson',
                    data: data
                });

                map.addLayer({
                    id: 'properties-layer',
                    type: 'circle',
                    source: 'properties',
                    paint: {
                        'circle-radius': 6,
                        'circle-color': '#34ebc6',
                        'circle-opacity': 0.95
                    },
                    minzoom: 8
                });

                map.addLayer({
                    id: 'highlighted-property',
                    type: 'circle',
                    source: 'properties',
                    paint: {
                        'circle-radius': 8,
                        'circle-color': '#FF9500',
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#FFFFFF',
                        'circle-opacity': 1
                    },
                    filter: ['==', 'id', '']
                });

                console.log("Properties layer added.");
            })
            .catch(error => {
                console.error("Error loading properties data:", error);
            });
    }

    searchBtn.addEventListener('click', async () => {
      const address = addressInput.value.trim();
      if (!address) return;

      loading.style.display = 'block';
      poiList.innerHTML = '';
      
      try {
        if (currentMarker) currentMarker.remove();
        poiMarkers.forEach(marker => marker.remove());
        poiMarkers = [];

        const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}`);
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          const location = data.features[0];
          const [lng, lat] = location.center;
          
          currentMarker = new mapboxgl.Marker({ color: '#4285f4' })
            .setLngLat([lng, lat])
            .addTo(map);
          
          map.flyTo({ center: [lng, lat], zoom: 15 });
          
          await fetchPOIs(lat, lng);
        } else {
          poiList.innerHTML = '<div class="poi-item">No results found for this address.</div>';
        }
      } catch (error) {
        poiList.innerHTML = `<div class="poi-item">Error: ${error.message}</div>`;
      } finally {
        loading.style.display = 'none';
      }
    });

    // map.on('click', async function(e) {
    //     const features = map.queryRenderedFeatures(e.point, { layers: ['properties-layer'] });
    //     if (features.length > 0) return;
        
    //     const { lng, lat } = e.lngLat;

    //     if (currentMarker) currentMarker.remove();
    //     poiMarkers.forEach(marker => marker.remove());
    //     poiMarkers = [];

    //     currentMarker = new mapboxgl.Marker({ color: '#4285f3' })
    //         .setLngLat([lng, lat])
    //         .addTo(map);

    //     await fetchPOIs(lat, lng);
    // });

    addressInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        searchBtn.click();
      }
    });

    function createPOIPopup(element) {
        const popupContent = document.createElement('div');
        popupContent.className = 'poi-popup-content';
        
        const tags = element.tags || {};
        const name = tags.name || 'Unnamed POI';
        const category = getElementCategory(element);

        popupContent.innerHTML = `<h4>${name}</h4>`;
        
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'poi-details';
        
        const table = document.createElement('table');
        
        if (category) {
            addTableRow(table, 'Category', formatCategoryName(category));
        }
        
        const commonTags = [
            { key: 'address', label: 'Address' },
            { key: 'addr:housenumber', label: 'House Number' },
            { key: 'addr:street', label: 'Street' },
            { key: 'addr:city', label: 'City' },
            { key: 'addr:postcode', label: 'Postal Code' },
            { key: 'phone', label: 'Phone' },
            { key: 'opening_hours', label: 'Hours' },
            { key: 'website', label: 'Website', isLink: true },
            { key: 'cuisine', label: 'Cuisine' },
            { key: 'operator', label: 'Operator' },
            { key: 'brand', label: 'Brand' }
        ];
        
        commonTags.forEach(tagInfo => {
            if (tags[tagInfo.key]) {
                let value = tags[tagInfo.key];
                if (tagInfo.isLink) {
                    value = `<a href="${value}" target="_blank">${value}</a>`;
                }
                addTableRow(table, tagInfo.label, value);
            }
        });
        
        if (!tags['address'] && (tags['addr:housenumber'] || tags['addr:street'])) {
            const addressParts = [];
            if (tags['addr:housenumber']) addressParts.push(tags['addr:housenumber']);
            if (tags['addr:street']) addressParts.push(tags['addr:street']);
            if (tags['addr:city']) addressParts.push(tags['addr:city']);
            if (tags['addr:postcode']) addressParts.push(tags['addr:postcode']);
            
            if (addressParts.length > 0) {
                addTableRow(table, 'Address', addressParts.join(', '));
            }
        }
        
        const additionalTagsShown = 5;
        let additionalTagsCount = 0;
        
        for (const key in tags) {
            if (commonTags.some(tag => tag.key === key) || key === 'name') continue;
            
            if (additionalTagsCount >= additionalTagsShown) break;
            
            addTableRow(table, formatTagName(key), tags[key]);
            additionalTagsCount++;
        }
        
        detailsDiv.appendChild(table);
        popupContent.appendChild(detailsDiv);
        
        return popupContent;
    }
    
    function formatTagName(key) {
        return key.split(':').pop().split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    
    function formatCategoryName(category) {
        return category.charAt(0).toUpperCase() + category.slice(1);
    }
    
    function addTableRow(table, label, value) {
        const row = table.insertRow();
        const cell1 = row.insertCell(0);
        const cell2 = row.insertCell(1);
        cell1.textContent = label;
        cell2.innerHTML = value; 
    }
    
    function getElementCategory(element) {
        const tags = element.tags || {};
        
        const categoryTags = ['amenity', 'shop', 'leisure', 'tourism', 'historic', 'office', 'craft', 'healthcare'];
        
        for (const tag of categoryTags) {
            if (tags[tag]) {
                return `${tag}: ${tags[tag]}`;
            }
        }
        
        return 'Point of Interest';
    }

    async function fetchPOIs(lat, lng, category = 'amenity', radius = 402) {
        console.log(`Making request at ${lat}, ${lng} for ${category} within ${radius}m`);

        poiList.innerHTML = '';
        poiMarkers.forEach(marker => marker.remove());
        poiMarkers = [];

        let query;
        if (category === 'amenity') {
            query = `
                [out:json];
                (
                  node(around:${radius},${lat},${lng})["amenity"];  
                  way(around:${radius},${lat},${lng})["amenity"];  
                  relation(around:${radius},${lat},${lng})["amenity"];  
                );
                out body;
                `;
        } else {
            query = `
                [out:json];
                (
                  node(around:${radius},${lat},${lng})["${category}"];  
                  way(around:${radius},${lat},${lng})["${category}"];  
                  relation(around:${radius},${lat},${lng})["${category}"];  
                );
                out body;
                `;
        }

        const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
        const data = await response.json();
        console.log("Overpass API response:", data);

        if (data.elements && data.elements.length > 0) {
            data.elements.forEach(element => {
                if (element.lat && element.lon) {
                    const poiMarker = new mapboxgl.Marker({ color: '#f44141' })
                        .setLngLat([element.lon, element.lat]);
                    
                    const popupContent = createPOIPopup(element);
                    const popup = new mapboxgl.Popup({ offset: 25 })
                        .setDOMContent(popupContent);
                    
                    poiMarker.setPopup(popup);
                    poiMarker.addTo(map);
                    poiMarkers.push(poiMarker);

                    const name = element.tags.name || 'Unnamed POI';
                    const type = getElementCategory(element);
                    const poiItem = document.createElement('div');
                    poiItem.className = 'poi-item';
                    poiItem.innerHTML = `<strong>${name}</strong><br>${type}`;
                    poiItem.onclick = () => {
                        map.flyTo({ center: [element.lon, element.lat], zoom: 17 });
                        poiMarker.togglePopup(); 
                    };
                    poiList.appendChild(poiItem);
                }
            });
        } else {
            poiList.innerHTML = `<div class="poi-item">No ${category === 'amenity' ? 'POIs' : category} found within ${(radius/1609).toFixed(2)} miles.</div>`;
        }
    }

    function highlightProperty(propertyId) {
        selectedPropertyId = propertyId;
        map.setFilter('highlighted-property', ['==', 'id', propertyId]);
    }

    function clearPropertyHighlight() {
        selectedPropertyId = null;
        map.setFilter('highlighted-property', ['==', 'id', '']);
    }

    function createPropertyPopup(feature, lngLat) {
        const popupContent = document.createElement('div');
        popupContent.className = 'property-popup-content';
        
        const propertyName = feature.properties.name || 'Property';
        const propertyId = feature.properties.id || '';
        
        popupContent.innerHTML = `
            <h4>${propertyName}</h4>
            <div class="property-search-form">
                <div class="input-group">
                    <label for="poi-category">Search for:</label>
                    <select id="poi-category">
                        <option value="amenity">All Amenities</option>
                        <option value="shop">Shops</option>
                        <option value="restaurant">Restaurants</option>
                        <option value="school">Schools</option>
                        <option value="leisure">Leisure</option>
                        <option value="healthcare">Healthcare</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="search-radius">Radius (miles):</label>
                    <input type="number" id="search-radius" min="0.1" max="5" step="0.1" value="1">
                </div>
                <button id="property-search-btn">Search</button>
            </div>
        `;
        
        const popup = new mapboxgl.Popup()
            .setLngLat(lngLat)
            .setDOMContent(popupContent)
            .addTo(map);
            
        popupContent.querySelector('#property-search-btn').addEventListener('click', async () => {
            const category = popupContent.querySelector('#poi-category').value;
            const radiusMiles = parseFloat(popupContent.querySelector('#search-radius').value);
            const radiusMeters = radiusMiles * 1609;
            
            highlightProperty(propertyId);
            popup.remove();
            await fetchPOIs(lngLat.lat, lngLat.lng, category, radiusMeters);
        });
        
        popup.on('close', () => {
            clearPropertyHighlight();
        });
    }

    map.on('load', () => {
        loadProperties().then(() => {
            map.on('click', 'properties-layer', (e) => {
                e.originalEvent.stopPropagation();
                
                const feature = e.features[0];
                const coordinates = feature.geometry.coordinates.slice();
                
                createPropertyPopup(feature, {
                    lng: coordinates[0],
                    lat: coordinates[1]
                });
            });
            
            map.on('mouseenter', 'properties-layer', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', 'properties-layer', () => {
                map.getCanvas().style.cursor = '';
            });
        });

        console.log('Map loaded and ready');
    });
  </script>
</body>
</html>