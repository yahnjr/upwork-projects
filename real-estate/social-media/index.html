<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Social Media Map</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
            transition: filter 0.3s ease;
        }
        
        #map.dimmed {
            filter: brightness(0.4) blur(1px);
        }
        
        #national-accounts-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #national-accounts-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.6);
            background: linear-gradient(135deg, #2563EB, #1E40AF);
        }
        
        .us-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        #cards-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #cards-overlay.visible {
            opacity: 1;
        }
        
        .cards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #region-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 0;
        }
        
        #close-cards {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #close-cards:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        #cards-container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            grid-auto-rows: max-content;
            gap: 24px;
            align-content: start;
            min-height: 0;
            max-height: calc(100vh - 80px);
        }
        
        #cards-container.single-card {
            display: flex;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 0;
        }
        
        #cards-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #cards-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        #cards-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        #cards-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .account-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.1),
                0 1px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .account-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 1px 8px rgba(0, 0, 0, 0.05);
        }

        .account-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #EC4899);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .account-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            flex-shrink: 0;
        }

        .account-info h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        .badge {
            background-color: #e0e7ff;
            color: #4338ca;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 999px;
            display: inline-block;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .card-body {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .card-footer {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-footer::before {
            content: 'üìç';
            font-size: 12px;
        }
    
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .account-card {
            animation: fadeInUp 0.3s ease forwards;
        }
        
        .account-card:nth-child(1) { animation-delay: 0.1s; }
        .account-card:nth-child(2) { animation-delay: 0.2s; }
        .account-card:nth-child(3) { animation-delay: 0.3s; }
        .account-card:nth-child(4) { animation-delay: 0.4s; }
        .account-card:nth-child(5) { animation-delay: 0.5s; }
        .account-card:nth-child(6) { animation-delay: 0.6s; }
        
        .mapboxgl-ctrl-group {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }
        
        .mapboxgl-ctrl-group button {
            background: transparent !important;
        }
        
        .mapboxgl-ctrl-group button:hover {
            background: rgba(0, 0, 0, 0.05) !important;
        }

        #context-menu {
            position: fixed;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.15),
                0 1px 8px rgba(0, 0, 0, 0.05);
            padding: 8px 0;
            min-width: 180px;
            z-index: 2000;
            display: none;
            backdrop-filter: blur(10px);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .context-menu-header {
            padding: 12px 16px 8px 16px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            margin-bottom: 4px;
        }

        .context-menu-item {
            padding: 12px 16px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: linear-gradient(90deg, #3B82F6, #2563EB);
            color: white;
            transform: translateX(2px);
        }

        .context-menu-item:first-of-type {
            border-radius: 8px 8px 0 0;
        }

        .context-menu-item:last-of-type {
            border-radius: 0 0 8px 8px;
        }

        .context-menu-item::before {
            content: 'üìç';
            font-size: 12px;
            opacity: 0.7;
        }

        .context-menu-item:hover::before {
            opacity: 1;
        }

        .context-menu-item[data-value="National Accounts"]::before {
            content: 'üåê';
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <button id="national-accounts-btn">
        <svg class="us-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM8 17.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5zM9.5 8C8.12 8 7 6.88 7 5.5S8.12 3 9.5 3 12 4.12 12 5.5 10.88 8 9.5 8zm5 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5zM16 9c-1.38 0-2.5-1.12-2.5-2.5S14.62 4 16 4s2.5 1.12 2.5 2.5S17.38 9 16 9z"/>
        </svg>
        <span>View National Accounts</span>
    </button>
    
    <div id="cards-overlay">
        <div class="cards-header">
            <h2 id="region-title">Region Accounts</h2>
            <button id="close-cards">
                <i class="fas fa-times"></i>
                Close
            </button>
        </div>
        <div id="cards-container">
        </div>
    </div>

    <div id="context-menu">
        <div class="context-menu-header">View accounts...</div>
        <div class="context-menu-item" data-value="25 Miles">25 Miles</div>
        <div class="context-menu-item" data-value="State">State</div>
        <div class="context-menu-item" data-value="Region">Region</div>
        <div class="context-menu-item" data-value="National Accounts">View National Accounts</div>
    </div>
   
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiaWZvcm1haGVyIiwiYSI6ImNsaHBjcnAwNDF0OGkzbnBzZmUxM2Q2bXgifQ.fIyIgSwq1WWVk9CKlXRXiQ';

        const regionColors = {
            'Midwest': '#3B82F6',
            'Mountain Northwest': '#8B5CF6',
            'North Central': '#06B6D4',
            'North Southeast': '#F59E0B',
            'Northeast': '#EF4444',
            'Northwest': '#10B981',
            'South Central': '#F97316',
            'South Southeast': '#84CC16',
            'Southwest': '#F59E0B',
            'West': '#EC4899'
        };

        let map;
        let regionsData = null;
        let socialMediaData = null;
        let currentActiveRegion = null;

        function initializeMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [-98.5795, 39.8283],
                zoom: 4
            });

            map.on('load', async () => {
                await loadData();
                setupLayers();
                setupInteractions();
            });
        }

        async function loadData() {
            try {
                const [regionsResponse, socialMediaResponse] = await Promise.all([
                    fetch('regions.geojson'),
                    fetch('SocialMedia.geojson')
                ]);

                regionsData = await regionsResponse.json();
                socialMediaData = await socialMediaResponse.json();

                console.log('Data loaded successfully');
                console.log('Regions:', regionsData.features.length);
                console.log('Social Media Points:', socialMediaData.features.length);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function setupLayers() {
            map.addSource('regions', {
                type: 'geojson',
                data: regionsData
            });

            map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'regions',
                paint: {
                    'fill-color': [
                        'case',
                        ...Object.entries(regionColors).flatMap(([region, color]) => [
                            ['==', ['get', 'Region'], region], 
                            color
                        ]),
                        '#cccccc'
                    ],
                    'fill-opacity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        5, 0.7,
                        8, 0
                    ]
                }
            });

            map.addLayer({
                id: 'regions-outline',
                type: 'line',
                source: 'regions',
                paint: {
                    'line-color': [
                        'case',
                        ...Object.entries(regionColors).flatMap(([region, color]) => [
                            ['==', ['get', 'Region'], region],
                            color
                        ]),
                        '#cccccc'
                    ],
                    'line-width': 4,
                    'line-opacity': 0
                },
                filter: ['==', 'Region', ''] 
            });

            map.addSource('social-media', {
                type: 'geojson',
                data: socialMediaData
            });

            map.loadImage('facebook-icon.png', (error, image) => {
                if (error) {
                    console.error('Error loading Facebook icon:', error);
                    return;
                }
                
                map.addImage('facebook-icon', image);

                map.addLayer({
                    id: 'social-media-points',
                    type: 'symbol',
                    source: 'social-media',
                    layout: {
                        'icon-image': 'facebook-icon',
                        'icon-size': 0.5,
                        'icon-allow-overlap': true
                    },
                    paint: {
                        'icon-opacity': 0
                    },
                    filter: ['==', 'Region', ''] 
                });

                map.addLayer({
                    id: 'social-media-points-unfiltered',
                    type: 'symbol',
                    source: 'social-media',
                    layout: {
                        'icon-image': 'facebook-icon',
                        'icon-size': 0.5,
                        'icon-allow-overlap': true
                    },
                    paint: {
                        'icon-opacity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            5, 0,
                            8, 1
                        ]
                    }
                });

                addRegionLabelsSimple();
            });
        }

        function setupInteractions() {
            map.on('click', 'regions-fill', (e) => {
                if (map.getZoom() < 6 && e.features.length > 0) {
                    const regionName = e.features[0].properties.Region;
                    activateRegion(regionName);
                }
            });
            
            map.on('click', 'social-media-points-unfiltered', (e) => {
                if (map.getZoom() >= 6 && e.features.length > 0) {
                    const account = e.features[0].properties;
                    showIndividualAccount(account);
                }
            });

            map.on('mouseenter', 'regions-fill', () => {
                if (map.getZoom() < 8) {
                    map.getCanvas().style.cursor = 'pointer';
                }
            });

            map.on('mouseleave', 'regions-fill', () => {
                map.getCanvas().style.cursor = '';
            });
            
            map.on('mouseenter', 'social-media-points-unfiltered', () => {
                if (map.getZoom() >= 8) {
                    map.getCanvas().style.cursor = 'pointer';
                }
            });

            map.on('mouseleave', 'social-media-points-unfiltered', () => {
                map.getCanvas().style.cursor = '';
            });

            document.getElementById('close-cards').addEventListener('click', hideCards);
            document.getElementById('national-accounts-btn').addEventListener('click', showNationalAccounts);
            
            document.getElementById('cards-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'cards-overlay') {
                    hideCards();
                }
            });

            document.addEventListener('contextmenu', showContextMenu);

            document.addEventListener('click', (e) => {
                const contextMenu = document.getElementById('context-menu');
                if (!contextMenu.contains(e.target)) {
                    hideContextMenu();
                }
            });
            
            document.getElementById('context-menu').addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        function activateRegion(regionName) {
            currentActiveRegion = regionName;
            
            animateFillOut(regionName);
            
            map.setFilter('regions-outline', ['==', 'Region', regionName]);
            
            setTimeout(() => {
                animateOutlineIn(regionName);
            }, 200);
            
            setTimeout(() => {
                animateSocialMediaPointsIn(regionName);
            }, 200);
            
            setTimeout(() => {
                showRegionCards(regionName);
            }, 2000);

            clearRegionMarkers();
        }

        function animateFillOut(regionName) {
            map.setFilter('regions-fill', ['!=', 'Region', regionName]);
            
            let currentOpacity = 0.7;
            const targetOpacity = 0.2;
            const step = 0.02;
            
            function fadeStep() {
                if (currentOpacity <= targetOpacity) {
                    map.setPaintProperty('regions-fill', 'fill-opacity', [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        5, targetOpacity,
                        8, 0
                    ]);
                    return;
                }
                
                currentOpacity -= step;
                map.setPaintProperty('regions-fill', 'fill-opacity', [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    5, Math.max(targetOpacity, currentOpacity),
                    8, 0
                ]);
                
                setTimeout(fadeStep, 30);
            }
            
            fadeStep();
        }

        function animateOutlineIn(regionName) {
            let pulseCount = 0;
            const maxPulses = 2;
            const regionColor = regionColors[regionName] || '#3B82F6';
            let animationFrame = 0;
            
            function pulse() {
                if (pulseCount >= maxPulses) {
                    map.setPaintProperty('regions-outline', 'line-opacity', 1);
                    map.setPaintProperty('regions-outline', 'line-width', 4);
                    map.setPaintProperty('regions-outline', 'line-color', regionColor);
                    return;
                }
                
                const progress = (animationFrame % 60) / 60; 
                const opacity = Math.max(0.2, 0.5 + Math.sin(progress * Math.PI * 2) * 0.4);
                const width = 3 + Math.sin(progress * Math.PI * 2) * 2;
                
                map.setPaintProperty('regions-outline', 'line-opacity', opacity);
                map.setPaintProperty('regions-outline', 'line-width', Math.max(2, width));
                map.setPaintProperty('regions-outline', 'line-color', regionColor);
                
                animationFrame++;
                
                if (animationFrame >= 60) {
                    pulseCount++;
                    animationFrame = 0;
                }
                
                if (pulseCount < maxPulses) {
                    requestAnimationFrame(pulse);
                } else {
                    setTimeout(() => {
                        map.setPaintProperty('regions-outline', 'line-opacity', 1);
                        map.setPaintProperty('regions-outline', 'line-width', 4);
                    }, 100);
                }
            }
            
            pulse();
        }

        function animateSocialMediaPointsIn(regionName) {
            map.setFilter('social-media-points', ['==', 'Region', regionName]);
            
            map.setPaintProperty('social-media-points', 'icon-opacity', 0);
            
            const regionPoints = socialMediaData.features.filter(
                feature => feature.properties.Region === regionName
            );
            
            if (regionPoints.length === 0) {
                return;
            }
            
            let currentOpacity = 0;
            const targetOpacity = 1;
            const step = 0.05;
            
            function fadeIn() {
                if (currentOpacity >= targetOpacity) {
                    map.setPaintProperty('social-media-points', 'icon-opacity', 1);
                    return;
                }
                
                currentOpacity += step;
                map.setPaintProperty('social-media-points', 'icon-opacity', Math.min(1, currentOpacity));
                
                setTimeout(fadeIn, 50);
            }
            
            setTimeout(fadeIn, 200);
        }

        function getRegionCenter(regionName) {
            const regionCenters = {
                'Midwest': [-89.0, 41.5],
                'Mountain Northwest': [-110.0, 45.0],
                'North Central': [-100.0, 47.0],
                'North Southeast': [-82.0, 35.0],
                'Northeast': [-74.0, 42.0],
                'Northwest': [-120.0, 47.0],
                'South Central': [-97.0, 32.0],
                'South Southeast': [-84.0, 32.0],
                'Southwest': [-111.0, 34.0],
                'West': [-119.0, 37.0]
            };
            return regionCenters[regionName] || [-98.5795, 39.8283];
        }

        function getDistance(coord1, coord2) {
            const dx = coord1[0] - coord2[0];
            const dy = coord1[1] - coord2[1];
            return Math.sqrt(dx * dx + dy * dy);
        }

        
        function showIndividualAccount(account) {
            const overlay = document.getElementById('cards-overlay');
            const titleElement = document.getElementById('region-title');
            const container = document.getElementById('cards-container');
            
            const name = account.Community_Name || account.Name || 'Unknown User';
            titleElement.textContent = `${name} - Individual Account`;
            
            container.className = 'single-card';
            container.innerHTML = createAccountCard(account, 0, true);
            
            overlay.style.display = 'flex';
            document.getElementById('map').classList.add('dimmed');
            
            setTimeout(() => {
                overlay.classList.add('visible');
            }, 10);
        }
        
        function showNationalAccounts() {
            const nationalAccounts = socialMediaData.features.filter(
                feature => feature.properties.Region === 'National'
            );
            
            if (nationalAccounts.length === 0) {
                alert('No national accounts found in the data.');
                return;
            }
            
            const overlay = document.getElementById('cards-overlay');
            const titleElement = document.getElementById('region-title');
            const container = document.getElementById('cards-container');
            
            titleElement.textContent = `National Social Media Accounts (${nationalAccounts.length})`;
            
            container.className = '';
            const cardsHTML = nationalAccounts.map((account, index) => {
                const props = account.properties;
                return createAccountCard(props, index);
            }).join('');
            
            container.innerHTML = cardsHTML;
            
            overlay.style.display = 'flex';
            document.getElementById('map').classList.add('dimmed');
            
            setTimeout(() => {
                overlay.classList.add('visible');
            }, 10);
        }

        function showRegionCards(regionName) {
            const overlay = document.getElementById('cards-overlay');
            const titleElement = document.getElementById('region-title');
            const container = document.getElementById('cards-container');
            
            const regionAccounts = socialMediaData.features.filter(
                feature => feature.properties.Region === regionName
            );
            
            titleElement.textContent = `${regionName} Social Media Accounts (${regionAccounts.length})`;
            
            container.className = '';
            const cardsHTML = regionAccounts.map((account, index) => {
                const props = account.properties;
                return createAccountCard(props, index);
            }).join('');
            
            container.innerHTML = cardsHTML;
            
            overlay.style.display = 'flex';
            document.getElementById('map').classList.add('dimmed');
            
            setTimeout(() => {
                overlay.classList.add('visible');
            }, 10);
        }

        function createAccountCard(props) {
            const name = props.Community_Name || 'Unknown Community';
            const state = props.State || 'Unknown State';
            const description = props.Description || 'No description provided.';
            const userType = props.Professional_or_User_Customer || 'User';

            const avatarLetter = name.charAt(0).toUpperCase();
            const userLabel = userType === 'Professional' ? 'Professional' : 'User';

            return `
                <div class="account-card">
                    <div class="card-header">
                        <div class="account-avatar">${avatarLetter}</div>
                        <div class="account-info">
                            <h3>${escapeHtml(name)}</h3>
                            <span class="badge">${escapeHtml(userLabel)}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${escapeHtml(description)}
                    </div>
                    <div class="card-footer">
                        ${escapeHtml(state)}
                    </div>
                </div>
            `;
        }


        function hideCards() {
            const overlay = document.getElementById('cards-overlay');
            
            overlay.classList.remove('visible');
            document.getElementById('map').classList.remove('dimmed');
            
            animateSocialMediaPointsOut();
            
            setTimeout(() => {
                animateOutlineOut();
            }, 300);
            
            setTimeout(() => {
                restoreFillLayer();
            }, 600);
            
            currentActiveRegion = null;
            
            setTimeout(() => {
                overlay.style.display = 'none';
                addRegionLabelsSimple();
            }, 900);
        }

        function animateSocialMediaPointsOut() {
            let currentOpacity = 1;
            const step = 0.08;
            
            function fadeOut() {
                if (currentOpacity <= 0) {
                    map.setPaintProperty('social-media-points', 'icon-opacity', 0);
                    return;
                }
                
                currentOpacity -= step;
                map.setPaintProperty('social-media-points', 'icon-opacity', Math.max(0, currentOpacity));
                
                setTimeout(fadeOut, 40);
            }
            
            fadeOut();
        }

        function animateOutlineOut() {
            let currentOpacity = 1;
            let currentWidth = 4;
            const opacityStep = 0.06;
            const widthStep = 0.15;
            
            function fadeOut() {
                if (currentOpacity <= 0) {
                    map.setFilter('regions-outline', ['==', 'Region', '']);
                    map.setPaintProperty('regions-outline', 'line-opacity', 0);
                    return;
                }
                
                currentOpacity -= opacityStep;
                currentWidth -= widthStep;
                
                map.setPaintProperty('regions-outline', 'line-opacity', Math.max(0, currentOpacity));
                map.setPaintProperty('regions-outline', 'line-width', Math.max(1, currentWidth));
                
                setTimeout(fadeOut, 30);
            }
            
            fadeOut();
        }

        function restoreFillLayer() {
            map.setFilter('regions-fill', null);
            
            let currentOpacity = 0.2;
            const targetOpacity = 0.7;
            const step = 0.03;
            
            function fadeIn() {
                if (currentOpacity >= targetOpacity) {
                    map.setPaintProperty('regions-fill', 'fill-opacity', [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        5, 0.7,
                        8, 0
                    ]);
                    return;
                }
                
                currentOpacity += step;
                map.setPaintProperty('regions-fill', 'fill-opacity', [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    5, Math.min(0.7, currentOpacity),
                    8, 0
                ]);
                
                setTimeout(fadeIn, 40);
            }
            
            fadeIn();
        }

        function formatNumber(num) {
            const numVal = parseInt(num) || 0;
            if (numVal >= 1000000) {
                return (numVal / 1000000).toFixed(1) + 'M';
            }
            if (numVal >= 1000) {
                return (numVal / 1000).toFixed(1) + 'K';
            }
            return numVal.toString();
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }


        function addRegionLabelsSimple() {
            const regionCounts = {};
            
            socialMediaData.features.forEach(feature => {
                const region = feature.properties.Region;
                if (region && region !== 'National') {
                    regionCounts[region] = (regionCounts[region] || 0) + 1;
                }
            });
            
            const regionCenters = {
                'Midwest': [-89.0, 41.5],
                'Mountain Northwest': [-110.0, 45.0],
                'North Central': [-100.0, 47.0],
                'North Southeast': [-82.0, 35.0],
                'Northeast': [-74.0, 42.0],
                'Northwest': [-120.0, 47.0],
                'South Central': [-97.0, 32.0],
                'South Southeast': [-84.0, 32.0],
                'Southwest': [-111.0, 34.0],
                'West': [-119.0, 37.0]
            };
            
            Object.entries(regionCounts).forEach(([regionName, count]) => {
                const center = regionCenters[regionName];
                if (center && count > 0) {
                    let size = 60;
                    let fontSize = 16;
                    if (count <= 5) {
                        size = 50;
                        fontSize = 14;
                    } else if (count <= 15) {
                        size = 60;
                        fontSize = 16;
                    } else if (count <= 30) {
                        size = 70;
                        fontSize = 18;
                    } else {
                        size = 80;
                        fontSize = 20;
                    }
                    
                    const regionColor = regionColors[regionName] || '#3B82F6';
                    
                    const el = document.createElement('div');
                    el.className = 'region-count-marker';
                    el.style.cssText = `
                        width: ${size}px;
                        height: ${size}px;
                        background: ${regionColor}CC;
                        border: 3px solid rgba(255, 255, 255, 0.9);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: ${fontSize}px;
                        color: white;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        user-select: none;
                    `;
                    el.textContent = count;
                    
                    el.addEventListener('mouseenter', () => {
                        el.style.background = `${regionColor}E6`;
                        el.style.boxShadow = '0 6px 16px rgba(0, 0, 0, 0.3)';
                        el.style.borderWidth = '4px';
                    });
                    
                    el.addEventListener('mouseleave', () => {
                        el.style.background = `${regionColor}CC`;
                        el.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
                        el.style.borderWidth = '3px';
                    });
                    
                    el.addEventListener('click', () => {
                        activateRegion(regionName);
                    });
                    
                    const marker = new mapboxgl.Marker(el)
                        .setLngLat(center)
                        .addTo(map);
                    
                    if (!map.regionMarkers) map.regionMarkers = [];
                    map.regionMarkers.push(marker);
                }
            });
        }

        function clearRegionMarkers() {
            if (map.regionMarkers) {
                map.regionMarkers.forEach(marker => marker.remove());
                map.regionMarkers = [];
            }
        }

        function showContextMenu(e) {
            e.preventDefault();
            
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.clientX + 'px';
            contextMenu.style.top = e.clientY + 'px';
            
            const menuRect = contextMenu.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            if (menuRect.right > windowWidth) {
                contextMenu.style.left = (e.clientX - menuRect.width) + 'px';
            }
            
            if (menuRect.bottom > windowHeight) {
                contextMenu.style.top = (e.clientY - menuRect.height) + 'px';
            }
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
        });

        window.addEventListener('resize', () => {
            if (map) {
                map.resize();
            }
        });
    </script>
</body>
</html>